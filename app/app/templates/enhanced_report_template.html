<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Multi-Scanner Security Report - {{ image_name }}</title>

    <!-- Google Fonts -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" />

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />

    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.2.2/css/buttons.bootstrap5.min.css" />

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />

    <style>
        :root {
            --primary-color: #0d6efd;
            --success-color: #198754;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #0dcaf0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa;
            color: #212529;
        }

        .report-container {
            max-width: 1600px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .report-header {
            background: linear-gradient(135deg, #2b3035 0%, #212529 100%);
            color: white;
            padding: 2rem;
            border-radius: 1rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .multi-scanner-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            font-size: 0.9rem;
            display: inline-block;
            margin-top: 1rem;
        }

        .stats-card {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            height: 100%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s ease;
        }

        .stats-card:hover {
            transform: translateY(-5px);
        }

        .severity-count {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 0.5rem 0;
        }

        .severity-critical { color: #dc3545; }
        .severity-high { color: #fd7e14; }
        .severity-medium { color: #ffc107; }
        .severity-low { color: #198754; }

        .scanner-indicator {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
            margin-right: 0.25rem;
        }

        .scanner-grype { background-color: #e3f2fd; color: #1976d2; }
        .scanner-trivy { background-color: #f3e5f5; color: #7b1fa2; }
        .scanner-both { background-color: #e8f5e9; color: #388e3c; }

        .confidence-high { border-left: 4px solid #198754; }
        .confidence-medium { border-left: 4px solid #ffc107; }

        .secret-alert {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 0.5rem;
        }

        .table-section {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .vuln-badge {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
        }

        .badge-critical { background-color: #dc3545; color: white; }
        .badge-high { background-color: #fd7e14; color: white; }
        .badge-medium { background-color: #ffc107; color: #212529; }
        .badge-low { background-color: #198754; color: white; }

        @media (max-width: 768px) {
            .report-container { margin: 1rem auto; }
            .severity-count { font-size: 2rem; }
        }
    </style>
</head>
<body>
    <div class="report-container">
        <!-- Report Header -->
        <div class="report-header">
            <div style="font-size: 2rem; font-weight: 600; margin-bottom: 0.5rem;">
                <i class="fas fa-shield-alt"></i> Multi-Scanner Security Report
            </div>
            <div style="font-size: 1.1rem; opacity: 0.9;">{{ image_name }}</div>
            <div style="margin-top: 0.5rem;">Scan ID: {{ scan_id }}</div>
            <div>Scan Date: {{ scan_date }}</div>

            {% if scanners_used %}
            <div class="multi-scanner-badge">
                <i class="fas fa-check-double"></i>
                Multi-Scanner Validation: {{ scanners_used | join(', ') | upper }}
            </div>
            {% endif %}

            <div style="margin-top: 1rem;">
                <span class="badge {{ 'bg-success' if scan_summary.status == 'Passed' else 'bg-danger' }}" style="font-size: 1rem; padding: 0.5rem 1rem;">
                    {{ scan_summary.status }}
                </span>
            </div>
        </div>

        <!-- Multi-Scanner Summary -->
        {% if scanners_used|length > 1 %}
        <div class="table-section">
            <h4><i class="fas fa-layer-group"></i> Multi-Scanner Analysis Summary</h4>
            <div class="row mt-3">
                <div class="col-md-3">
                    <div class="text-center p-3 bg-light rounded">
                        <div style="font-size: 2rem; color: #198754;">{{ both_scanners }}</div>
                        <div style="font-size: 0.9rem;">Found by Both Scanners</div>
                        <small class="text-muted">High Confidence</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center p-3 bg-light rounded">
                        <div style="font-size: 2rem; color: #1976d2;">{{ grype_unique }}</div>
                        <div style="font-size: 0.9rem;">Grype Only</div>
                        <small class="text-muted">Medium Confidence</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center p-3 bg-light rounded">
                        <div style="font-size: 2rem; color: #7b1fa2;">{{ trivy_unique }}</div>
                        <div style="font-size: 0.9rem;">Trivy Only</div>
                        <small class="text-muted">Medium Confidence</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center p-3 bg-light rounded">
                        <div style="font-size: 2rem; color: #fd7e14;">{{ total_secrets }}</div>
                        <div style="font-size: 0.9rem;">Secrets Detected</div>
                        <small class="text-muted">By Trivy</small>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Vulnerability Statistics -->
        <div class="stats-section mb-4">
            <div class="row g-4">
                <div class="col-md-3 col-sm-6">
                    <div class="stats-card">
                        <div style="font-size: 1rem; color: #6c757d;">Critical Vulnerabilities</div>
                        <div class="severity-count severity-critical">{{ severity_counts.Critical }}</div>
                        <small class="text-muted">
                            {% if fixable_counts %}
                            {{ fixable_counts.Critical }} fixable
                            {% endif %}
                        </small>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="stats-card">
                        <div style="font-size: 1rem; color: #6c757d;">High Vulnerabilities</div>
                        <div class="severity-count severity-high">{{ severity_counts.High }}</div>
                        <small class="text-muted">
                            {% if fixable_counts %}
                            {{ fixable_counts.High }} fixable
                            {% endif %}
                        </small>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="stats-card">
                        <div style="font-size: 1rem; color: #6c757d;">Medium Vulnerabilities</div>
                        <div class="severity-count severity-medium">{{ severity_counts.Medium }}</div>
                        <small class="text-muted">
                            {% if fixable_counts %}
                            {{ fixable_counts.Medium }} fixable
                            {% endif %}
                        </small>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="stats-card">
                        <div style="font-size: 1rem; color: #6c757d;">Low Vulnerabilities</div>
                        <div class="severity-count severity-low">{{ severity_counts.Low }}</div>
                        <small class="text-muted">
                            {% if fixable_counts %}
                            {{ fixable_counts.Low }} fixable
                            {% endif %}
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- SBOM Information -->
        {% if sbom_statistics %}
        <div class="table-section">
            <h4><i class="fas fa-box"></i> Software Bill of Materials (SBOM)</h4>
            <div class="row mt-3">
                <div class="col-md-4">
                    <div class="text-center p-3 bg-light rounded">
                        <div style="font-size: 2rem;">{{ sbom_statistics.total_packages }}</div>
                        <div>Total Packages</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="text-center p-3 bg-light rounded">
                        <div style="font-size: 2rem;">{{ sbom_statistics.license_count }}</div>
                        <div>Unique Licenses</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="text-center p-3 bg-light rounded">
                        <div style="font-size: 2rem;">{{ sbom_statistics.package_types|length }}</div>
                        <div>Package Types</div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Secrets Table -->
        {% if secrets and secrets|length > 0 %}
        <div class="table-section">
            <h4><i class="fas fa-key"></i> Secrets Detected ({{ total_secrets }})</h4>
            <div class="alert alert-warning mt-3">
                <i class="fas fa-exclamation-triangle"></i>
                <strong>Warning:</strong> Secrets were detected in this image. These should be removed immediately.
            </div>
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Rule ID</th>
                        <th>Severity</th>
                        <th>Title</th>
                        <th>File</th>
                    </tr>
                </thead>
                <tbody>
                    {% for secret in secrets[:20] %}
                    <tr>
                        <td><code>{{ secret.rule_id }}</code></td>
                        <td><span class="badge badge-{{ secret.severity|lower }}">{{ secret.severity }}</span></td>
                        <td>{{ secret.title }}</td>
                        <td><small>{{ secret.file }}</small></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}

        <!-- Vulnerabilities Table -->
        <div class="table-section">
            <h4><i class="fas fa-bug"></i> Fixable Vulnerabilities ({{ total_fixable }})</h4>
            <table id="vulnTable" class="table table-hover">
                <thead>
                    <tr>
                        <th>CVE ID</th>
                        <th>Severity</th>
                        <th>Package</th>
                        <th>Version</th>
                        <th>Fix Version</th>
                        <th>Scanner</th>
                        <th>Confidence</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for vuln in vulnerabilities %}
                    <tr class="confidence-{{ vuln.confidence|default('medium') }}">
                        <td><strong>{{ vuln.id }}</strong></td>
                        <td>
                            <span class="vuln-badge badge-{{ vuln.severity|lower }}">
                                {{ vuln.severity|upper }}
                            </span>
                        </td>
                        <td>{{ vuln.package_name }}</td>
                        <td><code>{{ vuln.package_version }}</code></td>
                        <td>
                            {% if vuln.fix_versions %}
                                <code>{{ vuln.fix_versions|join(', ') }}</code>
                            {% else %}
                                N/A
                            {% endif %}
                        </td>
                        <td>
                            {% for scanner in vuln.found_by %}
                            <span class="scanner-indicator scanner-{{ 'both' if vuln.found_by|length > 1 else scanner }}">
                                {{ scanner|upper }}
                            </span>
                            {% endfor %}
                        </td>
                        <td>
                            <span class="badge bg-{{ 'success' if vuln.confidence == 'high' else 'warning' }}">
                                {{ vuln.confidence|upper }}
                            </span>
                        </td>
                        <td>
                            {% if vuln.urls %}
                            <a href="{{ vuln.urls[0] }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-external-link-alt"></i> Details
                            </a>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Footer -->
        <div class="text-center py-4 text-muted">
            <div><strong>Generated by Multi-Scanner Docker Image Security Tool</strong></div>
            <div>Powered by Grype, Trivy & Syft</div>
            <div>{{ scan_date }}</div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.2.2/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.html5.min.js"></script>

    <script>
        $(document).ready(function() {
            $('#vulnTable').DataTable({
                dom: 'Bfrtip',
                buttons: ['copy', 'csv', 'excel'],
                pageLength: 25,
                order: [[1, 'asc'], [6, 'desc']],  // Sort by severity, then confidence
                columnDefs: [
                    { responsivePriority: 1, targets: [0, 1, 2] }
                ]
            });
        });
    </script>
</body>
</html>
